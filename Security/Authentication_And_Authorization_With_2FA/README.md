Two-Factor Authentication (2FA) adds an extra layer of security by requiring users to provide two forms of verification when logging in‚Äîtypically a password and a time-based one-time password (OTP) generated by
an authenticator app. The OTP is created using a secret key shared between the server and the app, ensuring that even if a password is compromised, unauthorised access is prevented.

In this version of the application, users log in by providing their email, password, and an OPT from Google Authenticator. The system verifies their credentials and OTP, then issues a short-lived
access token and a long-lived refresh token. The access token is used to authenticate API requests, while the refresh token allows getting a new access token without logging in again. When a user logs out, 
their access token is blacklisted, and their refresh token is deleted from the database, preventing further use. The only difference between this version and the previous version is the use of the OTP.

---
### BEFORE YOU START

‚ö†Ô∏è You will need to install the Google Authenticator App on your phone. 

‚ö†Ô∏è It is recommended that you work your way through the source code for [Security_With_Database_And_JWT_With_Login_And_Logout](https://github.com/lit-alan/api-design-and-dev/tree/main/Security/Security_With_Database_And_JWT_With_Login_And_Logout) before running this example.

---

#### **1Ô∏è‚É£ Our API generates a QR Code for a given user**

| ![image](https://github.com/user-attachments/assets/12dc0de4-b745-45c3-96d1-61397487f882)|
|:--------------------------------------------------------------------------------------:|
| **User navigates to `/generate-qr` and passes their email address (their username) to the app as a query param. The app returns a QR code that the user MUST SCAN with the Google Authenticator App on their phone.** |

_We could have got the user to pass their username/email address in the body of the request as opposed to using a query parameter_


The QR code is used to set up Two-Factor Authentication by encoding a secret key that the user scans into their authenticator app.
  
This allows the app to generate time-based OTPs that the user must enter when logging in. The secret key is stored in the database **AND** in the Authenticator App for each user.   
  

| ![image](https://github.com/user-attachments/assets/680aedae-c2db-4182-9340-ae830eda882c)|
|:--------------------------------------------------------------------------------------:|
| **The key is stored in the database for `Aoife Murphy`** |

The key is a Base32-encoded string. A Base32-encoded key is what Google Authenticator (or any TOTP-based app) uses to generate OTP's.

## How The Key Works

| Location	                        | Purpose                                                                              |
|-----------------------------------|--------------------------------------------------------------------------------------|
| Database (Backend)	              | Stores the Base32-encoded secret key for validating OTPs during login.               |
| Authenticator App (User‚Äôs Device)	| Stores the same secret key after scanning the QR code and generates OTPs based on it.| 

**OTP Generation Process**

‚û°Ô∏è The authenticator app takes the secret key and the current time.  
‚û°Ô∏è It applies the TOTP algorithm to generate a 6-digit OTP.  
‚û°Ô∏è The OTP changes every 30 seconds, ensuring security.  
  
**Example: OTP Calculation**
```
    - Secret Key: JBSWY3DPEHPK3PXP  
    - Current Timestamp: 1700000000  
    - Generated OTP: 123456  
    - After 30 seconds, the OTP changes based on the new timestamp.  
  ```

#### **2Ô∏è‚É£ User Scans the QR Code With the Google Authenticator App**
    
#### **3Ô∏è‚É£ User Notes the OPT that Appears on Their Phone**

| ![image](https://github.com/user-attachments/assets/2529265a-57e2-4322-81d8-4bd90c1272aa)|
|:--------------------------------------------------------------------------------------:|
| **The OTP is only valid for 30 seconds before a new one is generated** |


#### **4Ô∏è‚É£ User Authenticates Themselves to the System**

| ![image](https://github.com/user-attachments/assets/69c244a0-1649-498b-88f8-616ff204c1d8)|
|:--------------------------------------------------------------------------------------:|
| **User logs into the system with their username + password + OTP. If all are valid they get a short lived access token and a longer lived refresh token (as before)** |

_The user will only need the OPT when logging into the app_

#### **5Ô∏è‚É£   Authenticated User Can Access Restricted Resources by Sending The Access Token in the Authorisation Header**

| ![image](https://github.com/user-attachments/assets/713dc8f5-2e23-4a94-ba00-6b8b9e996343)|
|:--------------------------------------------------------------------------------------:|
| **Recieves the content and a status 200** |

---

#### Some Edge Cases:
| ![image](https://github.com/user-attachments/assets/4fdccf8b-dc9e-4ab6-b724-c4457abf66c5)|
|:--------------------------------------------------------------------------------------:|
| **If a user attempts to log in without an OTP, a status 400 BAD REQUEST is returned along with a suitable error message** |


|![image](https://github.com/user-attachments/assets/bcc4cd30-8e79-4563-b5a4-23298ca789dd)|
|:--------------------------------------------------------------------------------------:|
| **If a user attempts to log in wit an invalid or expired OTP, a status 401 UNAUTHORIZED is returned along with a suitable error message** |

---
**FUN FACT:**  A 6-digit OTP has 1,000,000 possible combinations (000000 to 999999), so the probability of guessing correctly on the first attempt is: **0.0001%** üòé    
  
If an attacker makes multiple guesses, the probability increases slightly, but since OTPs change every 30 seconds, brute-force attacks are highly impractical and many systems block accounts after multiple failed attempts.

_This application could be enhanced by only requiring administrators to use 2FA._

---
Note this addition of a `QRCodeController` and a `QRCodeService` to the project from the previous version. These classes are heavily commented to aid your understanding.    

I have also added a new field `otp` to the `AuthenticationRequest` class. 

There are a number of new dependencies added to the POM in this version - to produce the QR code and to provide support for Google Authenticator.  
  
The database has also been updated to include a `secret_key`column in the `users` table. This is to store the secret key used to generate and validate the OTP. The updated database script in included in the `resources` folder of the project. 